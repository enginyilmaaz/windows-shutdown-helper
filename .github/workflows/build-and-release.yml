name: Build and Release

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - dev

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore NuGet packages
        run: dotnet restore "Windows Shutdown Helper.sln"

      - name: Determine version and commit info
        id: version
        shell: pwsh
        run: |
          $commitHash = git rev-parse --short=6 HEAD
          echo "commit_short=$commitHash" >> $env:GITHUB_OUTPUT

          if ("${{ github.ref_name }}" -eq "master") {
            $latestTag = git tag -l "v*" --sort=-v:refname | Select-Object -First 1
            if ($latestTag) {
              $ver = $latestTag -replace '^v', ''
              $parts = $ver.Split('.')
              $major = [int]$parts[0]
              $minor = [int]$parts[1]
              $patch = [int]$parts[2] + 1
              $newVersion = "$major.$minor.$patch"
            } else {
              $newVersion = "1.0.1"
            }
            echo "version=$newVersion" >> $env:GITHUB_OUTPUT
            echo "is_release=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "version=dev" >> $env:GITHUB_OUTPUT
            echo "is_release=false" >> $env:GITHUB_OUTPUT
          }

          $setupName = "WindowsShutdownHelper_Setup_$( if ('${{ github.ref_name }}' -eq 'master') { $newVersion } else { 'dev' } )_$commitHash"
          echo "setup_name=$setupName" >> $env:GITHUB_OUTPUT

      - name: Inject Build ID
        shell: pwsh
        run: |
          $file = "src/BuildInfo.cs"
          (Get-Content $file) -replace 'public const string CommitId = "dev"', "public const string CommitId = ""${{ steps.version.outputs.commit_short }}""" | Set-Content $file

      - name: Build Release
        run: dotnet build "Windows Shutdown Helper.sln" -c Release --no-restore

      - name: Build Installer
        shell: pwsh
        run: |
          $url = "https://github.com/jrsoftware/issrc/releases/download/is-6_7_0/innosetup-6.7.0.exe"
          Invoke-WebRequest -Uri $url -OutFile innosetup.exe
          Start-Process -Wait -FilePath .\innosetup.exe -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /DIR=C:\InnoSetup"
          C:\InnoSetup\ISCC.exe "/DMyAppVersion=${{ steps.version.outputs.version }}" "/DCommitHash=${{ steps.version.outputs.commit_short }}" installer.iss

      - name: Upload Portable EXE
        uses: actions/upload-artifact@v4
        with:
          name: WindowsShutdownHelper_Portable
          path: |
            bin/Release/net8.0-windows/Windows Shutdown Helper.exe
            bin/Release/net8.0-windows/wwwroot/
            bin/Release/net8.0-windows/runtimes/

      - name: Upload Installer (dev)
        if: github.ref_name != 'master'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.setup_name }}
          path: installer_output/${{ steps.version.outputs.setup_name }}.exe

      - name: Publish GitHub Release
        if: github.ref_name == 'master'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
          make_latest: true
          files: |
            installer_output/${{ steps.version.outputs.setup_name }}.exe
